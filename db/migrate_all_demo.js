'use strict';

/**
 * Скрипт: убирает все упоминания "демо" из providers, offers, articles, faq.
 * Запуск: node db/migrate_all_demo.js
 */

const fs = require('fs');
const path = require('path');

const DEMO_DIR = path.join(__dirname, '..', 'demo_data');

function loadJson(name) {
    return JSON.parse(fs.readFileSync(path.join(DEMO_DIR, name), 'utf-8'));
}

function saveJson(name, data) {
    fs.writeFileSync(path.join(DEMO_DIR, name), JSON.stringify(data, null, 2), 'utf-8');
}

function hashStr(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) {
        h = ((h << 5) - h) + s.charCodeAt(i);
        h = h & h;
    }
    return Math.abs(h);
}

function pick(arr, seed) {
    return arr[Math.abs(seed) % arr.length];
}

// ─── Providers: about_short ───
const providerDescriptions = [
    'Российский облачный провайдер с собственными дата-центрами. Предлагает VPS/VDS серверы с NVMe-дисками и каналом от 100 Мбит/с.',
    'Хостинг-платформа для бизнеса и разработчиков. Гибкие тарифы, выделенные ресурсы и техподдержка 24/7.',
    'Облачная инфраструктура для проектов любого масштаба. Быстрое развёртывание, API и удобная панель управления.',
    'VPS-хостинг на базе KVM с гарантированными ресурсами. Дата-центры в России, SLA от 99.9%.',
    'Провайдер облачных серверов с фокусом на производительность. NVMe SSD, бесперебойное питание, защита от DDoS.',
    'Облачные серверы для веб-проектов, микросервисов и баз данных. Автоматическое масштабирование и резервное копирование.',
    'Виртуальные серверы на быстром оборудовании. Intel Xeon, ECC RAM, RAID-массивы с горячей заменой.',
    'IaaS-провайдер для стартапов и enterprise. Гибкая тарификация, мониторинг, DNS-хостинг в комплекте.',
    'Облачный хостинг с акцентом на надёжность. Собственная сеть, пиринг с крупнейшими IX-площадками.',
    'VDS-хостинг для разработчиков. Готовые образы ОС, one-click приложения, бесплатный тестовый период.',
    'Серверная платформа с возможностью кастомизации. Любые конфигурации: от 1 vCPU до выделенных кластеров.',
    'Российский IaaS-провайдер. Высокопроизводительные серверы на AMD EPYC и Intel Xeon, SSD/NVMe хранилище.',
    'Облачная инфраструктура для DevOps-команд. Terraform-провайдер, CI/CD интеграции, S3-совместимое хранилище.',
    'Надёжный хостинг с дата-центрами уровня Tier III. Резервированное электропитание, климат-контроль, физическая охрана.',
    'Провайдер виртуальных серверов с поминутной тарификацией. Быстрый деплой, снапшоты, приватные сети.',
    'Облачная платформа для e-commerce и SaaS. Высокая доступность, CDN, балансировка нагрузки.',
    'VPS/VDS хостинг с гарантией uptime 99.95%. Круглосуточный мониторинг, проактивное уведомление о проблемах.',
    'Российский облачный провайдер с гео-распределённой инфраструктурой. Серверы в Москве, Санкт-Петербурге и регионах.',
    'Платформа виртуализации для бизнес-приложений. 1С, CRM, ERP — оптимизированные конфигурации.',
    'Хостинг-провайдер с упором на безопасность. WAF, DDoS-защита, шифрование данных at rest и in transit.',
];

// ─── Offers: free_trial conditions ───
const trialConditions = [
    'Бесплатный тестовый период без привязки карты, с ограничением по трафику',
    'Тестовый период с базовой конфигурацией, без ограничений по функциональности',
    'Пробный период с лимитом на исходящий трафик, полный доступ к панели',
    'Бесплатный тест: стандартная конфигурация, ограничение по полосе пропускания',
    'Тестовый доступ с полным функционалом, лимит по CPU и RAM',
    'Пробный период без карты, доступ ко всем функциям панели управления',
    'Тестовый период с ограничением по объёму хранилища и трафику',
    'Бесплатный тест: полная конфигурация, ограничение 1 сервер на аккаунт',
];

// ─── Articles ───
const articleExcerpts = [
    'Практический гайд по выбору облачного сервера: ключевые метрики, чек-листы и расчёт стоимости владения.',
    'Сравнение типов виртуализации KVM и OpenVZ: производительность, изоляция и когда что выбирать.',
    'Как правильно оценить производительность VPS: бенчмарки CPU, I/O и сети, на что обращать внимание.',
    'Обзор рынка VPS/VDS в России: ценовые сегменты, типичные конфигурации и тренды.',
    'Руководство по миграции между хостинг-провайдерами: планирование, инструменты, минимизация даунтайма.',
    'Оптимизация затрат на облачную инфраструктуру: reserved instances, spot-серверы, right-sizing.',
    'Чек-лист безопасности для VPS: от первичной настройки до мониторинга и бэкапов.',
    'Как выбрать дата-центр: Tier-уровни, географическое расположение и связность.',
    'NVMe vs SSD vs HDD для серверов: когда какой тип диска оправдан.',
    'Мониторинг VPS своими руками: Prometheus, Grafana и настройка алертов.',
    'SLA хостинг-провайдеров: что стоит за цифрами и как считать реальный uptime.',
    'Автоматизация серверной инфраструктуры: Ansible, Terraform и best practices.',
    'Масштабирование веб-приложений: от одного VPS до отказоустойчивого кластера.',
    'Защита VPS от DDoS-атак: провайдерские решения, Cloudflare и собственные настройки.',
    'Docker на VPS: установка, оптимизация и управление контейнерами в продакшене.',
    'PostgreSQL на VPS: настройка производительности, WAL, репликация и бэкапы.',
    'Сетевая инфраструктура VPS: приватные сети, VLAN, маршрутизация между серверами.',
    'CI/CD на базе VPS: GitLab Runner, Jenkins и GitHub Actions self-hosted.',
    'Сравнение панелей управления: ISPmanager, Hestia, CyberPanel — плюсы и минусы.',
    'Kubernetes на VPS: миниатюрные кластеры для стартапов и pet-проектов.',
    'Бэкапы VPS: стратегии 3-2-1, инкрементальные копии и проверка восстановления.',
    'Выбор ОС для сервера: Ubuntu, Debian, CentOS, AlmaLinux — обзор и рекомендации.',
    'Оптимизация Nginx для высокой нагрузки: worker_processes, кэширование и gzip.',
    'Стоимость владения VPS: скрытые расходы, трафик, бэкапы и мониторинг.',
];

const articleContents = [
    '## Введение\n\nВыбор облачного сервера — одно из ключевых решений для любого IT-проекта. В этой статье разберём основные критерии выбора.\n\n### На что обращать внимание\n\n- **CPU**: тип процессора (Intel Xeon, AMD EPYC), количество ядер и тип аллокации (shared/dedicated)\n- **RAM**: объём и тип памяти (ECC/non-ECC)\n- **Диски**: NVMe SSD обеспечивают лучший I/O, но дороже обычных SSD\n- **Сеть**: полоса пропускания, лимиты трафика, наличие DDoS-защиты\n- **SLA**: гарантированный uptime и компенсации при простое\n\n### Расчёт стоимости\n\nПри расчёте TCO учитывайте не только стоимость аренды, но и:\n\n1. Стоимость бэкапов\n2. Дополнительный трафик\n3. IP-адреса\n4. Техподдержка (если не входит в тариф)\n\n### Вывод\n\nНе существует универсального решения — выбирайте конфигурацию под свои задачи. Используйте тестовые периоды, запускайте бенчмарки и сравнивайте реальную производительность.',
    '## Обзор\n\nРынок VPS/VDS в России продолжает расти. Основные тренды — переход на NVMe-накопители, увеличение полосы пропускания и внедрение поминутной тарификации.\n\n### Типичные конфигурации\n\n| Сегмент | vCPU | RAM | Диск | Цена |\n|---------|------|-----|------|------|\n| Базовый | 1-2 | 1-2 ГБ | 20-40 ГБ SSD | 300-600 ₽/мес |\n| Средний | 2-4 | 4-8 ГБ | 40-80 ГБ NVMe | 600-1500 ₽/мес |\n| Продвинутый | 4-8 | 8-16 ГБ | 80-200 ГБ NVMe | 1500-4000 ₽/мес |\n\n### На что смотреть\n\n- **Реальная производительность** CPU — запускайте sysbench и Geekbench\n- **I/O диска** — fio покажет реальные IOPS\n- **Сетевая связность** — проверяйте пинги до ключевых точек\n- **Качество поддержки** — время ответа на тикеты\n\n### Полезные инструменты\n\n```bash\n# Тест CPU\nsysbench cpu --threads=4 run\n# Тест диска\nfio --name=test --rw=randread --bs=4k --numjobs=4 --iodepth=32\n# Тест сети\niperf3 -c speedtest-server\n```',
    '## Руководство\n\nМиграция между хостинг-провайдерами — процесс, требующий планирования. Ключевые этапы:\n\n### 1. Подготовка\n\n- Составьте список всех сервисов и зависимостей\n- Оцените объём данных для переноса\n- Выберите время с минимальной нагрузкой\n- Подготовьте откат\n\n### 2. Перенос данных\n\n- Используйте rsync для файлов: `rsync -avz --progress`\n- Для баз данных: pg_dump / mysqldump с репликацией\n- DNS: уменьшите TTL заблаговременно\n\n### 3. Проверка\n\n- Запустите smoke-тесты на новом сервере\n- Проверьте SSL-сертификаты\n- Убедитесь в корректности DNS-резолвинга\n\n### 4. Переключение\n\n- Обновите DNS-записи\n- Мониторьте метрики первые 24 часа\n- Держите старый сервер как fallback минимум неделю',
];

const faqAnswers = [
    'VPS (Virtual Private Server) — виртуальный выделенный сервер. Физический сервер делится на несколько изолированных виртуальных машин. Каждая VPS получает гарантированные ресурсы: CPU, RAM, диск и сеть. В отличие от shared-хостинга, вы имеете root-доступ и полный контроль над конфигурацией.',
    'При выборе VPS обращайте внимание на: тип CPU (shared или dedicated ядра), тип диска (NVMe SSD быстрее обычных SSD), объём трафика, наличие DDoS-защиты, SLA-гарантии и качество техподдержки. Рекомендуем воспользоваться тестовым периодом и запустить бенчмарки под вашу нагрузку.',
    'KVM — полная виртуализация с собственным ядром ОС. OpenVZ — контейнерная виртуализация с общим ядром. KVM обеспечивает лучшую изоляцию и поддержку любых ОС, но требует больше накладных расходов. OpenVZ легче и дешевле, но ограничен Linux.',
    'Для начала оцените требования проекта: CPU (для compute-задач важны тактовая частота и IPC), RAM (под базы данных и кэш), диск (NVMe для высоконагруженных I/O операций). Начните с минимальной конфигурации и масштабируйте по мере роста нагрузки.',
    'SLA (Service Level Agreement) определяет гарантированный уровень доступности сервера. 99.9% означает допустимый даунтайм ~8.7 часов в год, 99.95% — ~4.4 часа. При нарушении SLA провайдер обычно компенсирует стоимость простоя.',
];

// ─── Migrate providers ───
console.log('[migrate] Обработка providers.json...');
const providers = loadJson('providers.json');
let pChanged = 0;
for (const p of providers) {
    if (p.about_short && p.about_short.includes('Демо')) {
        p.about_short = pick(providerDescriptions, hashStr(p.id));
        pChanged++;
    }
}
saveJson('providers.json', providers);
console.log(`[migrate] Провайдеры: обновлено ${pChanged}`);

// ─── Migrate offers ───
console.log('[migrate] Обработка offers.json...');
const offers = loadJson('offers.json');
let oChanged = 0;
for (const o of offers) {
    const trial = o.free_trial;
    if (trial && trial.conditions && trial.conditions.includes('Демо')) {
        trial.conditions = pick(trialConditions, hashStr(o.id));
        oChanged++;
    }
}
saveJson('offers.json', offers);
console.log(`[migrate] Офферы: обновлено ${oChanged}`);

// ─── Migrate articles ───
console.log('[migrate] Обработка articles.json...');
const articles = loadJson('articles.json');
let aChanged = 0;
for (let i = 0; i < articles.length; i++) {
    const a = articles[i];
    if (a.excerpt && a.excerpt.includes('демо')) {
        a.excerpt = articleExcerpts[i % articleExcerpts.length];
        aChanged++;
    }
    if (a.content_md && a.content_md.includes('Демо')) {
        a.content_md = articleContents[i % articleContents.length];
        aChanged++;
    }
}
saveJson('articles.json', articles);
console.log(`[migrate] Статьи: обновлено полей ${aChanged}`);

// ─── Migrate FAQ ───
console.log('[migrate] Обработка faq.json...');
const faq = loadJson('faq.json');
let fChanged = 0;
for (let i = 0; i < faq.length; i++) {
    if (faq[i].a && faq[i].a.includes('демо')) {
        faq[i].a = faqAnswers[i % faqAnswers.length];
        fChanged++;
    }
}
saveJson('faq.json', faq);
console.log(`[migrate] FAQ: обновлено ${fChanged}`);

console.log('[migrate] Готово! Запустите npm run seed для обновления БД.');
